# å‰åç«¯åˆä½œæ–°æ¨¡å¼

æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€ç§å…¨æ–°çš„å‰åç«¯åˆä½œæ¨¡å¼ï¼Œåœ¨ä»‹ç»è¿™ç§æ¨¡å¼ä¹‹å‰å’‹ä»¬å…ˆæ¥çœ‹çœ‹å‰åç«¯åˆä½œæ¨¡å¼çš„æ¼”å˜ã€‚

> singsongï¼šè¯¥æ¨¡å¼ä¸»è¦å¯¹ä¼ ç»Ÿå¤šé¡µé¢åº”ç”¨æ„å»ºçš„æ”¹è¿›ã€‚å…³äº SPAï¼ˆSingle Page Applicationï¼Œå•é¡µåº”ç”¨ç¨‹åºï¼‰å¯ä»¥å‚è€ƒ SRRï¼ˆServer-Side Renderï¼ŒæœåŠ¡ç«¯æ¸²æŸ“ï¼‰ã€‚

## æ¼”å˜

åœ¨é‚£ä¸ªå‰ç«¯è§’è‰²æ¯”è¾ƒå¼±åŒ–çš„å¹´ä»£ï¼Œé¡µé¢ä¸»è¦ä»¥é™æ€é¡µé¢ä¸ºä¸»ã€‚åˆä½œæ¨¡å¼å¾ˆç®€å•ç²—æš´ã€‚

![model-1](https://raw.githubusercontent.com/zhansingsong/create-fes/master/docs/dev-model/imgs/dev-model-1.png)

å‰ç«¯å¼€å‘å®Œé¡µé¢ï¼Œè¾“å‡ºç»™åç«¯ã€‚åç«¯æ‹¿åˆ°é¡µé¢æ‹¼æ¨¡æ¿ï¼Œç„¶åå†æ¸²æŸ“è¾“å‡ºã€‚ä½†éšç€å‰ç«¯ä¸šåŠ¡å¤æ‚æ€§é€æ¸åœ°å¢åŠ ï¼Œè¿™ç§æ¨¡å¼åˆä½œèµ·æ¥å°±ä¸æ˜¯å¾ˆæ„‰å¿«äº†ã€‚**åç«¯åœ¨æ‹¼æ¨¡æ¿æ—¶ï¼Œä¸èƒ½ç¡®ä¿è¾“å‡ºçš„é¡µé¢ç»“æ„ä¸å‰ç«¯ä¿æŒä¸€è‡´**ã€‚ä¸ºäº†è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œèªæ˜çš„å¼€å‘äººå‘˜å°±ç»™å‰ç«¯åŒå­¦å»ºè®®ï¼š**ä½¿ç”¨åç«¯å¼€å‘ç¯å¢ƒå¼€å‘å‰ç«¯é¡µé¢**ã€‚

![model-2](https://raw.githubusercontent.com/zhansingsong/create-fes/master/docs/dev-model/imgs/dev-model-2.png)

å‰ç«¯ç›´æ¥åœ¨æœ¬åœ°éƒ¨ç½²åç«¯å¼€å‘ç¯å¢ƒï¼Œåªè´Ÿè´£ views å¼€å‘ã€‚å†åŸºäºä»£ç æ‰˜ç®¡å·¥å…· gitï¼Œå®ç°å‰åç«¯çš„åˆä½œã€‚æ­¤æ—¶è¿˜æ˜¯ä»¥åç«¯ä¸ºä¸»å¯¼ï¼Œç»´æŠ¤æ€§æˆæœ¬ä¾ç„¶å¾ˆé«˜ã€‚

éšç€ node.js çš„å´›èµ·ï¼Œå‰ç«¯å·¥ç¨‹åŒ–ä¹Ÿé€æ¸æˆä¸ºå‰ç«¯å¼€å‘é‡è¦ç»„æˆéƒ¨åˆ†ã€‚å„ç§æ„å»ºå·¥å…·ï¼ˆå¦‚ webpackã€rollupã€gruntã€gulp ç­‰ï¼‰ï¼ŒMVVM æ¡†æ¶ï¼ˆå¦‚ Reactã€Vueã€Angular ç­‰ï¼‰ï¼Œæ¨¡å—åŒ–ç³»ç»Ÿï¼ˆcjsã€amdã€umdã€ES6-modules ç­‰ï¼‰ï¼ŒCSS é¢„å¤„ç†å™¨ï¼ˆSASSã€Lessã€Stylusã€Postcss ç­‰ï¼‰ï¼Œæ¨¡å—ç®¡ç†å·¥å…·ï¼ˆNPMã€Yarnã€brower ç­‰ï¼‰çŠ¹å¦‚é›¨åæ˜¥ç¬‹èˆ¬ä¸æ–­æ¶Œç°ã€‚SAP ä¹Ÿå¼€å§‹åœ¨å‰ç«¯é¢†åŸŸæµè¡Œæ¥ï¼Œå‰ç«¯èƒ½åšçš„äº‹æƒ…æ›´å¤šã€‚å¦‚å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œé™æ€åˆ†æã€ä¼˜åŒ–æ‰“åŒ…ç­‰ã€‚åç«¯åªéœ€è´Ÿè´£æ•°æ®æä¾›ã€‚æ­¤æ—¶ï¼Œå‰åç«¯å·²å®Œå…¨åˆ†ç¦»ï¼Œå„è‡ªè´Ÿè´£å„è‡ªçš„ä¸šåŠ¡ã€‚

![model-3](https://raw.githubusercontent.com/zhansingsong/create-fes/master/docs/dev-model/imgs/dev-model-3.png)

è¿™ç§åˆä½œæ¨¡å¼çš„æ ¸å¿ƒï¼š**å®¢æˆ·ç«¯æ¸²æŸ“ + æ¥å£**ã€‚ç”±äºåŸºäºå®¢æˆ·ç«¯æ¸²æŸ“ï¼Œå¯¹æµè§ˆå™¨çš„ SEO ä¸æ˜¯å¾ˆå‹å¥½ã€‚è™½ç„¶å¯ä»¥é€šè¿‡ SRR æ¥è§£å†³ï¼Œä½†æ˜¯ SRR ä¹Ÿå­˜åœ¨å±€é™æ€§ã€‚å…³äº SRR æ„Ÿå…´è¶£çš„åŒå­¦å¯è‡ªè¡ŒæŸ¥é˜…ç›¸å…³çš„èµ„æ–™ã€‚æœ¬æ–‡ä¸»è¦æ¢è®¨ä¼ ç»Ÿå¤šé¡µé¢åº”ç”¨æ„å»ºçš„ä¼˜åŒ–ã€‚

åŸºäºå‰ç«¯å·¥ç¨‹åŒ–ï¼Œè¦è®©ä¼ ç»Ÿå¤šé¡µé¢åº”ç”¨æ„å»ºä¹Ÿæ”¯æŒå‰åç«¯å®Œå…¨åˆ†ç¦»ã€‚è¿˜éœ€è¦åšä¸€ä»¶äº‹ï¼Œå‰ç«¯è„šæ‰‹æ¶éœ€è¦ä¸åç«¯ä½¿ç”¨ç›¸åŒçš„æ¨¡æ¿æ¸²æŸ“å¼•æ“ã€‚å‰ç«¯ç¼–å†™å¥½åï¼Œç›´æ¥è¾“å‡ºæ¨¡æ¿ç»™åç«¯ä½¿ç”¨ã€‚ä¸ºæ­¤è‡ªå·±ä¹Ÿæ„å»ºä¸€ä¸ª [fes](fes) è„šæ‰‹æ¶ã€‚

![model-4](https://raw.githubusercontent.com/zhansingsong/create-fes/master/docs/dev-model/imgs/dev-model-4.png)

åœ¨ä½¿ç”¨ [fes](fes) æ„å»ºäº†å‡ ä¸ªé¡¹ç›®åï¼Œè™½ç„¶åœ¨å¼€å‘ä½“éªŒã€å¼€å‘æ•ˆç‡ä¸Šéƒ½å¾—åˆ°äº†å¾ˆå¤§åœ°æå‡ã€‚ä½†ä¸åç«¯åˆä½œèµ·æ¥ä¸æ˜¯å¾ˆè½»æ¾ã€‚å› ä¸ºåœ¨å¼€å‘ä¹‹å‰éœ€è¦ä¸åç«¯çº¦å®šå¥½æ¨¡æ¿æ•°æ®å˜é‡ï¼Œä¸€èˆ¬ä¼šä»¥æ–‡æ¡£å½¢å¼è¿›è¡Œè¯´æ˜ã€‚å¦‚æœåç«¯æ›´æ–°äº†æ•°æ®ï¼Œæ²¡åŒæ­¥æ›´æ–°æ–‡æ¡£ï¼Œå°±ä¼šå­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å¯¹å¼€å‘æ•ˆç‡å¤§æ‰“æŠ˜æ‰£ï¼Œä¸ä¼ ç»Ÿçš„åç«¯é‡æ–°æ‹¼æ¥æ¨¡æ¿ç›¸æ¯”ä¼˜åŠ¿ä¸æ˜¯å¾ˆæ˜æ˜¾ã€‚ç§‰ç€ geek çš„ç²¾ç¥ï¼Œå°±æƒ³èƒ½ä¸èƒ½ **å°†æ¨¡æ¿æ•°æ®ä»¥æ¥å£çš„å½¢å¼æä¾›ç»™å‰ç«¯**ã€‚è¿™æ ·ä¸Šè¿°é—®é¢˜ä¸å°±è¿åˆƒè€Œè§£äº†ä¹ˆã€‚

![model-5](https://raw.githubusercontent.com/zhansingsong/create-fes/master/docs/dev-model/imgs/dev-model-5.png)

äºæ˜¯å°±å¯¹ [fes](fes) è¿›è¡Œæ”¹é€ ã€‚è®©å…¶æ”¯æŒæ¨¡æ¿æ•°æ®æ¥å£çš„é…ç½®ï¼Œåœ¨æ¸²æŸ“ä¹‹å‰ä¼šæ ¹æ®é…ç½®æ‹‰èµ·æ¥å£æ•°æ®ï¼Œå†è¿›è¡Œæ¸²æŸ“è¾“å‡ºã€‚åŒæ—¶è¿˜æä¾›äº†æ¥å£æ•°æ®é€‚é…åŠŸèƒ½ï¼Œèƒ½è®©å®¢æˆ·ç«¯æ›´å¥½åœ°æ§åˆ¶æ•°æ®ç»“æ„ã€‚

```js
mockConfig: {
  // è®¿é—®è·¯å¾„ä½œä¸ºkey
  '/index': {
    // æä¾›æ¸²æŸ“æ¨¡æ¿æ•°æ®æ¥å£
    api: 'https://postman-echo.com/get?page=index',
    // é€‚é…æ•°æ®
    format: data => data.args,
  },
  '/fes/info': {
    api: 'https://postman-echo.com/get?page=info',
    format: data => data.args,
  },
}
```

å¦å¤–ï¼Œä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹æ¨¡æ¿æ•°æ®ï¼Œå¼€å‘æ¨¡å¼ä¸‹è¾“å…¥ `mock` æŒ‡ä»¤å¯è·å–å½“å‰çš„æ¨¡æ¿æ•°æ®ã€‚

```js
$ mock
Mock Data:

{
    "/about": {
        "page": "about",
        "common": "commons",
        "data": "singsong",
        "name": "fes-about-page"
    },
    "/index": {
        "page": "index",
        "common": "commons",
        "name": "fes-index-page",
        "data": {
            "name": "fes"
        },
        "article": {
            "_value": {},
            "_state": 1
        }
    },
    "/post": {
        "common": "commons"
    }
}
```

å¦‚æœéœ€è¦æŸ¥çœ‹å¯¹åº”é¡µé¢æ•°æ®ï¼Œåªéœ€è¾“å…¥å¯¹åº”çš„è·¯å¾„å³å¯ã€‚å¦‚ `/index`ã€‚

```js
$ /index
Mock Data [/index]:

{
    "page": "index",
    "common": "commons",
    "name": "fes-index-page",
    "data": {
        "name": "fes"
    },
    "article": {
        "_value": {},
        "_state": 1
    }
}
```

é™¤äº† mock æŒ‡ä»¤ï¼Œè¿˜æä¾›äº†å¦‚ä¸‹æŒ‡ä»¤ï¼š

- mock: æŸ¥çœ‹å½“å‰çš„ mock æ•°æ®
- view: æ‰“å°èŒƒå›´åœ°å€å’ŒäºŒç»´ç ä¿¡æ¯
- clear: æ¸…ç©ºæ§åˆ¶å°

**è¿™ç§åˆä½œæ¨¡å¼ï¼Œéœ€è¦åç«¯å¤šåšä¸€ä»¶äº‹ã€‚é¢å¤–æä¾›ä¸€ä¸ªåŒ…å«æ¨¡æ¿æ•°æ®çš„æ¥å£ä¾›å‰ç«¯ä½¿ç”¨ï¼ˆåªå­˜åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼Œåœ¨ä¸Šçº¿æ—¶éœ€è¦å…³é—­æ‰ï¼‰ã€‚åªéœ€å¯¹è¯¥ç±»æ¥å£å®šä¹‰ç‰¹å®šçš„å‰ç¼€ï¼Œç„¶ååœ¨æ¨¡æ¿æ¸²æŸ“é€»è¾‘ä¹‹å‰æ‹¦æˆªè¯·æ±‚å“åº”æ•°æ®ã€‚è¿™æ ·ä¸ä»…èƒ½ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œè€Œä¸”ç»´æŠ¤èµ·æ¥ä¹Ÿæ–¹ä¾¿ã€‚**

## Demo

è¿™é‡Œä»¥æ”¹è¿›å [fes](fes) è¿›è¡Œæ¼”ç¤ºã€‚å¦‚ä¸‹ä»¥ `index é¡µé¢` ä¸ºä¾‹è¿›è¡Œè®²è§£ï¼š

### å‰ç«¯ä¿®æ”¹

index é¡µé¢è·¯ç”±ä¸ºï¼š`http://127.0.0.1:3001/index`ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>{{ title }}</title>
  </head>
  <body>
    <h1>{{ title }}</h1>
  </body>
</html>
```

æ¨¡æ¿æ•°æ®æ¥å£ä¸ºï¼š`http://127.0.0.1:3001/mockdata/index`ã€‚å…¶ä¸­`/mockdata`ä¸ºå‰ç¼€ï¼Œæ¥å£è¿”å›çš„æ•°æ®å¦‚ä¸‹ï¼š

```js
{
  "rawdata": {
    "title": "index page"
  },
}
```

åœ¨ fes ä¸­å¯¹æ¨¡æ¿æ•°æ®æ¥å£è¿›è¡Œå¦‚ä¸‹é…ç½®

```js
mockConfig: {
  // è®¿é—®è·¯å¾„ä½œä¸ºkey
  '/index': {
    // æä¾›æ¸²æŸ“æ¨¡æ¿æ•°æ®æ¥å£
    api: 'http://127.0.0.1:3001/mockdata/index',
  }
}
```

è¿™é‡Œå¦‚æœåªæƒ³è¦ `rawdata` ä¸­çš„å˜é‡æ•°æ®ã€‚å¯ä»¥é€šè¿‡`format` è¿›è¡Œé€‚é…ã€‚æœ€åçš„é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

```js
mockConfig: {
  // è®¿é—®è·¯å¾„ä½œä¸ºkey
  '/index': {
    // æä¾›æ¸²æŸ“æ¨¡æ¿æ•°æ®æ¥å£
    api: 'http://127.0.0.1:3001/mockdata/index',
    // é€‚é…æ•°æ®
    format: data => data.rawdata,
  }
}
```

### åç«¯ä¿®æ”¹

- è·¯ç”±å¤„ç†å™¨

  ```js
  //path: ./controllers/index.js
  module.exports = async ctx => {
    const {url} = ctx;
    // ä» DB è·å–æ•°æ®
    const getDataFromDB = () => {
      // åšä¸€äº›æ•°æ®æŸ¥è¯¢æ“ä½œâ€¦â€¦
      return {
        rawdata: {
          title: 'index page',
        },
      };
    };
    const data = getDataFromDB();

    // åˆ¤æ–­æ˜¯å¦æœ‰å‰ç¼€è¿›è¡Œä¸åŒçš„å“åº”
    // è¿™é‡Œå‰ç¼€å·²ä¿å­˜åœ¨ ctx.mockApiPrefix ä¸­
    if (url.indexOf(ctx.mockApiPrefix) === 0) {
      ctx.body = data;
    } else {
      await ctx.render('index', data.rawdata);
    }
  };
  ```

- å®šä¹‰è·¯ç”±

  ```js
  // path: ./pages/index.js
  // è¯¥æ¥å£ä¸é¡µé¢è¯·æ±‚ä½¿ç”¨ç›¸åŒçš„è·¯ç”±å¤„ç†ï¼Œé€šè¿‡æ˜¯å¦æœ‰`PREFIX`è¿›è¡ŒåŒºåˆ«
  module.exports = (PREFIX = '') => [
    {
      method: 'get',
      path: `${PREFIX}/index`,
      middleware: require('./controllers/index'),
    },
  ];
  ```

- æ³¨å†Œè·¯ç”±

  ```js
  const Router = require('koa-router');
  const router = new Router();

  const pagesConfig = require('./pages/index');

  const config = [];
  // å®šä¹‰å‰ç¼€
  const MOCK_API_PREFIX = '/mockdata';
  // æ³¨å†Œé¡µé¢è·¯ç”±
  config.push(...pagesConfig());

  // æ³¨å†Œæ¨¡æ¿æ•°æ®æ¥å£
  if (process.env.NODE === 'dev') {
    config.push(...pagesConfig(MOCK_API_PREFIX));
  }

  const generateRoutes = (router, config) => {
    config.forEach(({method, path, middleware}) => {
      router[method](path, middleware);
    });
  };

  module.exports = app => (ctx, next) => {
    // ç»‘å®šå‰ç¼€ï¼Œæ–¹ä¾¿åç»­é€»è¾‘ä½¿ç”¨
    ctx.mockApiPrefix = MOCK_API_PREFIX;
    generateRoutes(router, config);
    app.use(router.routes()).use(router.allowedMethods());
    return next();
  };
  ```

è¿è¡Œæ•ˆæœï¼š

![](https://raw.githubusercontent.com/zhansingsong/create-fes/master/docs/dev-model/imgs/dev-model.gif)


## æ€»ç»“

æœ¬æ–‡ä¸»è¦ä¸å¤§å®¶åˆ†äº«ä¸€ç§å‰åç«¯åˆä½œæ–°æ¨¡å¼ï¼Œä¹Ÿè®¸å½“æˆä¸€ç§æ–°æ€è·¯æ›´æ°å½“äº›ğŸ˜€ï¼Œå› ä¸ºå®ƒåªæ˜¯å¯¹å¤šé¡µé¢åº”ç”¨æ„å»ºçš„ä¸€ç§ä¼˜åŒ–ã€‚

[fes]: https://github.com/zhansingsong/create-fes "fes"
